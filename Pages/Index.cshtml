@page
@using LivingRoom.Broadcast
@model IndexModel
@{
    ViewData["Title"] = "Living Room";
}

<div class="main-video">
    @if (Model.CurrentBroadcast is BroadcastInfo info)
    {
        <video id="stream" class="video-js vjs-default-skin" controls>
            <source src="streams/@info.SessionId/live.m3u8" type="application/x-mpegURL" />
        </video>
    }
    else
    {
        <div class="nothing-playing">Nothing is playing right now. Check back later!</div>
    }
</div>


@section Styles {
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@@silvermine/videojs-chromecast@1.5.0/dist/silvermine-videojs-chromecast.min.css">
}

@section Scripts {
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@silvermine/videojs-chromecast@1.5.0/dist/silvermine-videojs-chromecast.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
        console.log('Starting!');
        const videoElement = document.getElementById('stream');
        if (videoElement) {
            console.log('Found video!');
            const options = {
                fluid: true, 
                techOrder: ["chromecast", "html5"], 
                chromecast: {
                    modifyLoadRequestFn: loadRequest => { // HLS support
                        console.log('modifyLoadRequestFn');
                        loadRequest.media.hlsSegmentFormat = 'fmp4';
                        loadRequest.media.hlsVideoSegmentFormat = 'fmp4';
                        return loadRequest;
                    }
                },
                plugins: { 
                    chromecast: {
                        receiverAppID: "9043DB46"
                    } 
                }
            };

            const player = videojs(videoElement, options);
        }
    </script>
}